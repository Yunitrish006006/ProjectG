# ESP32-S3 ProjectG 按鈕錄音系統測試報告

## 測試目標

將 ESP32-S3 ProjectG 音訊專案從開機自動錄音（MQTT 音訊）模式，改為「按下按鈕開始錄音，再按一次停止並處理音訊」的模式。

## 實現的功能

### ✅ 已完成功能

1. **按鈕錄音控制系統**
   - ✅ 全局變數 `buttonRecordingMode = true` 啟用按鈕錄音模式
   - ✅ 錄音狀態變數：`isRecording`、`pendingAudioProcessing`
   - ✅ 錄音時間追蹤：`recordingStartTime`、`recordingDuration`
   - ✅ 按鈕防抖動機制 (200ms)

2. **I2S 音訊處理**
   - ✅ 麥克風 I2S 設置函數 `setupMicrophone()`
   - ✅ I2S 資源清理函數 `cleanupI2SResources()`
   - ✅ 按鈕錄音啟動函數 `startButtonRecording()`
   - ✅ 按鈕錄音停止函數 `stopButtonRecordingAndProcess()`
   - ✅ 音訊處理函數 `processRecordedAudio()`

3. **系統狀態指示**
   - ✅ OLED 顯示：`Btn: READY` / `Btn: REC` / `Btn: PROC`
   - ✅ LED 狀態：待機(綠色) / 錄音中(紅色呼吸燈) / 處理中(藍色)
   - ✅ 串行輸出詳細狀態資訊

4. **任務管理與同步**
   - ✅ FreeRTOS 任務分離：按鈕控制、麥克風處理、OLED 顯示
   - ✅ I2S 互斥鎖保護資源訪問
   - ✅ 隊列機制處理 LED 和音量控制命令

### 🔧 當前測試狀態

1. **基本系統運行**
   - ✅ ESP32-S3 成功啟動並連接 WiFi (IP: 192.168.137.73)
   - ✅ 所有 FreeRTOS 任務正常運行
   - ✅ LED 測試序列完成，控制系統正常
   - ✅ 按鈕錄音模式已啟用並就緒

2. **I2S 音訊系統**
   - ✅ 麥克風 I2S 配置 (I2S_NUM_1, 16kHz, 16bit)
   - ✅ 引腳配置：WS=GPIO18, SD=GPIO21, SCK=GPIO20
   - ✅ 按鈕觸發的 I2S 初始化與清理機制

3. **音訊數據處理**
   - ✅ 16位有符號整數音訊採樣
   - ✅ 256樣本緩衝區處理
   - ✅ 音訊電平計算與顯示
   - ✅ 串行輸出音訊數據用於分析

### ⚠️ 已知問題與修復

1. **MQTT 連接問題**
   - ❌ MQTT 客戶端連接不穩定，導致系統崩潰
   - 🔧 **解決方案**：暫時停用 MQTT 功能，專注測試 I2S 基本功能
   - 📝 後續需要優化 MQTT 連接錯誤處理

2. **LED 命令結構問題**
   - ❌ LED 命令結構初始化不完整
   - ✅ **已修復**：補全 LedCommandData 結構初始化

### 🎯 測試計劃

#### 階段一：基本 I2S 錄音測試 (當前階段)

- [x] 系統啟動與狀態顯示
- [ ] 按鈕觸發錄音啟動測試
- [ ] 音訊數據采集驗證
- [ ] 按鈕觸發錄音停止測試
- [ ] I2S 資源釋放驗證

#### 階段二：MQTT 音訊傳輸測試

- [ ] 修復 MQTT 連接穩定性
- [ ] MQTT 音訊數據發布測試
- [ ] Python 客戶端接收驗證
- [ ] 特徵提取功能測試

#### 階段三：完整系統集成測試

- [ ] 端到端錄音流程測試
- [ ] 長時間穩定性測試
- [ ] 錯誤恢復機制驗證
- [ ] 性能優化

## 技術規格

### 硬體配置

- **MCU**: ESP32-S3 N16R8
- **WiFi**: YunRog 網絡 (192.168.137.73)
- **麥克風介面**: I2S (I2S_NUM_1)
- **控制按鈕**: GPIO42 (麥克風控制)
- **LED 指示**: GPIO48 (NeoPixel) + GPIO35/36/37 (RGB)
- **OLED 顯示**: I2C (SDA=GPIO8, SCL=GPIO9)

### 軟體架構

- **RTOS**: FreeRTOS 多任務
- **音訊格式**: 16kHz, 16bit, 單聲道
- **緩衝大小**: 256樣本 (512字節)
- **DMA 配置**: 4個緩衝區，每個512樣本
- **通信協議**: MQTT (broker.emqx.io:1883)

## 操作說明

### 按鈕錄音操作流程

1. **系統就緒**: OLED 顯示 `Btn: READY`，LED 綠色
2. **開始錄音**: 按下 GPIO42 按鈕，OLED 顯示 `Btn: REC`，LED 紅色呼吸燈
3. **停止錄音**: 再次按下 GPIO42 按鈕，OLED 顯示 `Btn: PROC`，LED 藍色
4. **處理完成**: 系統自動回到就緒狀態

### 串行監控輸出

- 錄音期間輸出音訊數據和電平信息
- 詳細的 I2S 初始化與清理日誌
- 錄音時長和統計信息
- 系統狀態和錯誤信息

## 下一步計劃

1. **實機按鈕測試**: 物理按下 GPIO42 按鈕測試錄音流程
2. **MQTT 連接優化**: 修復 MQTT 客戶端穩定性問題
3. **Python 接收端**: 完善 MQTT 音訊數據接收與分析
4. **性能調優**: 優化音訊處理性能和資源使用
5. **文檔完善**: 更新使用手冊和故障排除指南

---

**測試環境**: Windows 11, PlatformIO, Python 3.x  
**最後更新**: 2025-06-26 03:40  
**狀態**: 基本 I2S 功能就緒，等待按鈕測試
