# ProjectG 麥克風整合功能說明

## 🎯 功能概述

已成功將麥克風串口傳輸功能整合到 ProjectG 的 main.cpp 中，現在系統同時支援：

- 音頻播放（I2S 輸出）
- 麥克風錄音（I2S 輸入，通過串口傳輸）
- 音量控制按鈕
- 麥克風開關按鈕
- OLED 顯示所有狀態

## 🔌 硬體連接

### 原有功能引腳

- **音頻播放**: GPIO 15, 16, 17 (I2S_NUM_0)
- **音量控制**: GPIO 1 (音量+), GPIO 2 (音量-)
- **OLED 顯示**: GPIO 8 (SDA), GPIO 9 (SCL)

### 新增麥克風功能引腳

- **麥克風 I2S**: GPIO 18 (WS), GPIO 19 (SD), GPIO 20 (SCK) (I2S_NUM_1)
- **麥克風控制**: GPIO 3 (開關按鈕)

### 連接圖

```
ESP32-S3              I2S 麥克風
GPIO18 (WS)    ->    WS (字選擇)
GPIO19 (SD)    ->    SD (數據)
GPIO20 (SCK)   ->    SCK (時鐘)
3.3V           ->    VCC
GND            ->    GND

按鈕連接:
GPIO3          ->    麥克風開關按鈕 -> GND
```

## 🎮 控制方式

### 按鈕控制

- **GPIO1 按鈕**: 音量增加
- **GPIO2 按鈕**: 音量減少  
- **GPIO3 按鈕**: 麥克風開關（啟動/停止錄音）

### 串口命令

- 仍可通過串口輸入音頻 URL 更改播放源
- 串口會輸出麥克風音頻數據

## 📱 OLED 顯示

螢幕會顯示：

```
System Status
Uptime: 123s
RAM: 234kB
WiFi: Connected      [WiFi圖標]
Audio: Playing Vol:12  Mic: ON
```

## ⚙️ 技術細節

### 音頻參數

- **播放音頻**: 由 AudioPlayer 類別管理，支援網路串流
- **麥克風音頻**: 16kHz, 16位元, 單聲道
- **串口傳輸**: 115200 波特率

### 任務分配

- **主核心 (PRO_CPU)**:
  - LED 控制任務
  - 呼吸燈任務
  - 音頻播放任務（高優先級）
- **副核心 (APP_CPU)**:
  - OLED 更新任務
  - 按鈕控制任務
  - 麥克風任務

### I2S 端口分配

- **I2S_NUM_0**: 用於音頻播放輸出
- **I2S_NUM_1**: 用於麥克風音頻輸入

## 🚀 使用流程

1. **系統啟動**
   - 自動初始化所有組件
   - OLED 顯示系統狀態
   - 執行 LED 測試序列

2. **音頻播放**  
   - WiFi 連接後自動開始播放預設電台
   - 可通過按鈕調整音量
   - 串口可輸入新的音頻 URL

3. **麥克風使用**
   - 按下 GPIO3 按鈕啟動麥克風
   - 音頻數據會通過串口傳輸
   - OLED 顯示麥克風狀態
   - 再次按下按鈕停止錄音

## 🖥️ 電腦端接收

使用之前創建的 `audio_receiver.py`：

```bash
python audio_receiver.py
```

修改串口設定：

```python
SERIAL_PORT = 'COM3'  # 根據實際串口修改
```

## 📊 系統監控

### 串口輸出示例

```
=== ProjectG 系統啟動 ===
Volume control and microphone buttons initialized
WiFi已連接
IP地址: 192.168.1.100
✓ 麥克風 I2S 設定成功
Volume UP button pressed
Volume UP: 13
Microphone control button pressed
✓ 麥克風已啟動
```

### 記憶體使用

- 增加麥克風任務後，預估增加約 6KB RAM 使用
- 總任務數：7個（原5個 + 麥克風任務 + 按鈕控制任務）

## 🛠️ 故障排除

### 常見問題

1. **麥克風無聲音**
   - 檢查 I2S 麥克風連接
   - 確認 GPIO 18, 19, 20 連接正確
   - 按下 GPIO3 確認麥克風已啟動

2. **按鈕無響應**
   - 檢查按鈕接地連接
   - 確認按鈕防抖動正常工作

3. **音頻播放中斷**
   - 兩個 I2S 端口可能有衝突
   - 檢查 WiFi 連接穩定性

### 調試技巧

- 監控串口輸出查看系統狀態
- OLED 顯示提供即時狀態資訊
- 任務優先級已優化避免衝突

## 🔄 未來擴展

可能的改進方向：

- 添加音頻錄製到 SD 卡功能
- 實現音頻壓縮以減少串口傳輸量
- 支援雙向音頻通訊
- 添加音頻處理濾波器
- 整合語音識別功能

## 📝 代碼修改摘要

主要修改項目：

- 新增 I2S 麥克風驅動和控制函數
- 擴展按鈕控制任務支援麥克風開關
- 更新 OLED 顯示包含麥克風狀態
- 創建獨立的麥克風任務
- 使用第二個 I2S 端口避免衝突

系統現在是一個功能完整的音頻處理平台，同時支援播放和錄音功能！
