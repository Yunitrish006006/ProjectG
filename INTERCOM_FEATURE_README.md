# ProjectG 對講功能說明

## 🎙️ 新功能：麥克風對講模式

現在當您按下麥克風按鈕時，系統會：

1. **暫停音樂播放** - 停止當前的網路電台
2. **啟動對講模式** - 麥克風聲音直接輸出到喇叭
3. **即時語音傳輸** - 低延遲的語音回放

## 🎮 操作方式

### 啟動對講模式

1. 按下 **GPIO42** 按鈕
2. 系統自動：
   - 暫停音樂播放
   - 啟動麥克風錄音
   - 將音頻直接輸出到喇叭
3. OLED 顯示變為：`Audio: Intercom Vol:12  Mic: TALK`

### 停止對講模式

1. 再次按下 **GPIO42** 按鈕
2. 系統自動：
   - 停止麥克風錄音
   - 恢復音樂播放
   - 回到正常播放模式
3. OLED 顯示變為：`Audio: Playing Vol:12  Mic: OFF`

## 📱 OLED 顯示狀態

### 正常播放模式

```
System Status
Uptime: 123s
RAM: 234kB
WiFi: Connected
Audio: Playing Vol:12  Mic: OFF
```

### 對講模式

```
System Status
Uptime: 123s
RAM: 234kB
WiFi: Connected
Audio: Intercom Vol:12  Mic: TALK
```

### 錄音模式 (未來擴展)

```
System Status
Uptime: 123s
RAM: 234kB
WiFi: Connected
Audio: Playing Vol:12  Mic: REC
```

## ⚙️ 技術細節

### 音頻處理流程

**正常模式:**

```
網路電台 → AudioPlayer → I2S_NUM_0 → 喇叭
```

**對講模式:**

```
麥克風 → I2S_NUM_1 → 音頻緩衝 → I2S_NUM_0 → 喇叭
```

### 採樣率配置

- **麥克風輸入**: 16kHz, 16位元, 單聲道
- **喇叭輸出**: 16kHz, 16位元, 單聲道 (對講模式)
- **音樂播放**: 44.1kHz, 16位元, 立體聲 (正常模式)

### I2S 端口分配

- **I2S_NUM_0**: 音樂播放 ↔ 對講輸出 (動態切換)
- **I2S_NUM_1**: 麥克風輸入 (固定)

## 🔧 硬體要求

### 必要組件

1. **I2S 麥克風** (如 INMP441)
   - GPIO18 → WS
   - GPIO21 → SD  
   - GPIO20 → SCK

2. **I2S 喇叭/DAC** (如 MAX98357A)
   - GPIO16 → BCLK
   - GPIO17 → LRC
   - GPIO15 → DIN

3. **控制按鈕**
   - GPIO42 → 對講開關按鈕

## 🎯 使用場景

### 對講機功能

- 按住按鈕說話，放開停止
- 適合短距離語音通訊
- 即時語音回饋

### 語音測試

- 測試麥克風和喇叭是否正常
- 檢查音頻延遲
- 調整音量設定

### 監聽功能

- 環境聲音監聽
- 語音品質測試

## 🚀 進階功能 (未來可擴展)

### 語音錄製

- 錄製到 SD 卡
- 播放錄音檔案
- 語音留言功能

### 網路對講

- 透過 WiFi 傳輸語音
- 多人對講功能
- 遠距離通訊

### 語音處理

- 回音消除
- 噪音抑制
- 音量自動調整

## 📊 性能資訊

### 音頻延遲

- **麥克風到喇叭**: 約 20-50ms
- **緩衝區大小**: 256 樣本
- **處理頻率**: 實時處理

### 記憶體使用

- **音頻緩衝**: 512 bytes
- **任務堆疊**: 6KB
- **總增加**: 約 8KB RAM

### CPU 使用率

- **對講模式**: 約 15-20%
- **正常模式**: 約 10%
- **任務優先級**: 中等 (2)

## 🛠️ 故障排除

### 常見問題

1. **無法聽到聲音**
   - 檢查麥克風連接
   - 確認音量設定
   - 檢查喇叭連接

2. **聲音延遲太大**
   - 減少緩衝區大小
   - 提高任務優先級
   - 檢查 CPU 負載

3. **音質不佳**
   - 檢查接地連接
   - 確認電源穩定
   - 調整採樣率

### 調試方法

1. **串口監控**

   ```
   ✓ 麥克風已啟動，音樂已暫停，切換到對講模式
   ✓ I2S 輸出設定成功（對講模式）
   ✓ 麥克風已停止，音樂已恢復
   ```

2. **OLED 狀態檢查**
   - 觀察模式切換
   - 確認音量顯示
   - 檢查麥克風狀態

3. **按鈕測試**
   - 確認防抖動正常
   - 檢查狀態切換
   - 驗證音頻切換

現在您的 ProjectG 具備了完整的對講功能！🎵🎙️
