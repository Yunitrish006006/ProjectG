# 🎙️ ESP32-S3 ProjectG 按鈕錄音模式 使用指南

## 📋 系統概述

ESP32-S3 ProjectG 現已支援按鈕控制的錄音模式，使用者可以透過按下麥克風按鈕來控制錄音的開始和結束，實現更精確的音訊錄製與處理。

## 🔧 功能特色

- **🎯 按需錄音**: 只在需要時錄音，節省系統資源
- **📊 音訊處理**: 錄音結束後自動進行音訊處理和特徵提取
- **📡 MQTT 傳輸**: 音訊數據和特徵通過 MQTT 即時傳送
- **💡 LED 狀態指示**: 不同顏色的 LED 表示系統狀態
- **📟 OLED 顯示**: 即時顯示錄音狀態

## 🎮 操作方式

### 基本操作流程

1. **開始錄音**: 按下麥克風按鈕 (GPIO 14)
2. **停止錄音**: 再次按下麥克風按鈕
3. **自動處理**: 系統自動處理音訊並通過 MQTT 傳送

### 系統狀態說明

#### LED 狀態指示

- **🟢 綠色常亮**: 系統就緒，等待錄音
- **🔴 紅色呼吸燈**: 正在錄音中
- **🔵 藍色常亮**: 正在處理音訊數據

#### OLED 顯示狀態

- **`Btn: READY`**: 按鈕錄音系統就緒
- **`Btn: REC`**: 正在錄音中
- **`Btn: PROC`**: 正在處理音訊

## 📡 MQTT 數據輸出

### 音訊數據主題

- **原始音訊**: `esp32/audio/raw`
  - 格式: 16-bit PCM, 16kHz 單聲道
  - 封包大小: 256 樣本

### 特徵數據主題

- **MFCC 特徵**: `esp32/audio/mfcc`
- **Mel 頻譜**: `esp32/audio/mel`
- **統計特徵**: `esp32/audio/features`

## 🔧 系統配置

### 錄音模式切換

在 `src/main.cpp` 中修改以下變量來切換模式:

```cpp
// 按鈕控制錄音模式
bool buttonRecordingMode = true;   // true: 按鈕模式, false: 持續錄音模式
```

### 硬體連接

- **麥克風按鈕**: GPIO 14 (支持防彈跳處理)
- **音量 UP**: GPIO 12
- **音量 DOWN**: GPIO 13
- **麥克風**: I2S (BCLK: GPIO 4, LRC: GPIO 5, DIN: GPIO 6)

## 📊 技術規格

### 音訊參數

- **採樣率**: 16 kHz
- **位深**: 16-bit
- **聲道**: 單聲道 (Mono)
- **緩衝區大小**: 256 樣本

### 特徵提取

- **MFCC**: 13 維梅爾倒頻係數
- **Mel**: 26 個梅爾濾波器
- **統計特徵**: 均值、標準差、能量等

### 網路傳輸

- **MQTT 服務器**: broker.emqx.io:1883
- **傳輸協議**: MQTT v3.1.1
- **QoS 等級**: 0 (Fire and Forget)

## 🛠️ 故障排除

### 常見問題與解決方案

#### 1. 按鈕無反應

- 檢查 GPIO 14 連接
- 確認按鈕防彈跳時間 (預設 200ms)
- 查看串行輸出是否有按鈕事件

#### 2. 錄音無法開始

- 確認 I2S 麥克風連接正確
- 檢查 MQTT 連接狀態
- 查看 LED 狀態指示

#### 3. MQTT 數據未傳送

- 確認 WiFi 連接穩定
- 檢查 MQTT 服務器可達性
- 使用 Python 診斷工具驗證

## 🔬 測試工具

### Python 端工具

1. **`monitor_serial.py`** - ESP32 串行監控
2. **`mqtt_diagnostic.py`** - MQTT 數據診斷
3. **`realtime_audio_receiver.py`** - 即時音訊接收播放

### 測試命令

```bash
# 監控 ESP32 狀態
python monitor_serial.py

# 診斷 MQTT 數據流
python mqtt_diagnostic.py

# 即時接收音訊
python realtime_audio_receiver.py
```

## 📈 性能數據

### 錄音效能

- **啟動延遲**: < 500ms
- **停止延遲**: < 200ms
- **處理時間**: 約 2 秒 (包含 MQTT 傳輸)

### 記憶體使用

- **錄音緩衝**: 512 bytes
- **MQTT 隊列**: 最多 10 個音訊包
- **特徵緩衝**: 各類型 20 個包

## 🔄 系統流程圖

```
[待機] -> [按鈕按下] -> [開始錄音] -> [錄音中]
   ^                                      |
   |                                      v
[處理完成] <- [MQTT傳送] <- [音訊處理] <- [按鈕再按下]
```

## 🎯 使用場景

### 適用情況

- **語音命令錄製**: 短時間語音指令
- **音訊樣本收集**: 特定音訊片段錄製
- **語音識別測試**: 音訊數據準備
- **聲學實驗**: 受控音訊錄製環境

### 優勢

- **資源節約**: 僅在需要時使用系統資源
- **精確控制**: 準確控制錄音開始和結束時間
- **即時處理**: 錄音結束立即進行音訊分析
- **狀態反饋**: 清晰的視覺和顯示狀態指示

---

**開發完成**: 2025-06-26  
**版本**: v2.0 - 按鈕錄音模式  
**狀態**: ✅ 功能完整，測試通過
