# ESP32-S3 ProjectG - MQTT éŸ³è¨Šå‚³éèˆ‡ç‰¹å¾µæå–ç³»çµ±

## ğŸ“– å°ˆæ¡ˆæ¦‚è¿°

æœ¬ç³»çµ±æ˜¯åŸºæ–¼ ESP32-S3 N16R8 é–‹ç™¼æ¿çš„éŸ³è¨Šè™•ç†å°ˆæ¡ˆï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ MQTT éŸ³è¨Šå‚³éã€æ¢…çˆ¾é »è­œç‰¹å¾µæå–ã€LED æ§åˆ¶å’Œ OLED é¡¯ç¤ºã€‚ç³»çµ±æ¡ç”¨ç©©å®šçš„ MQTT å”è­°å‚³ééŸ³è¨Šæ•¸æ“šå’Œç‰¹å¾µï¼Œæ”¯æ´å¯¦æ™‚éŸ³è¨Šåˆ†æã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- âœ… **MQTT éŸ³è¨Šå‚³é**ï¼šé€é MQTT å”è­°å¯¦æ™‚å‚³é€ 16kHz 16ä½éŸ³è¨Šæ•¸æ“š
- âœ… **ç‰¹å¾µæå–**ï¼šå¯¦æ™‚è¨ˆç®— MFCCã€æ¢…çˆ¾èƒ½é‡ã€é »è­œé‡å¿ƒç­‰éŸ³è¨Šç‰¹å¾µ
- âœ… **LED æ§åˆ¶ç³»çµ±**ï¼šRGB LED å’Œ NeoPixel æ§åˆ¶ï¼ŒåŒ…å«å„ç¨®ç‡ˆæ•ˆ
- âœ… **OLED é¡¯ç¤º**ï¼šå¯¦æ™‚é¡¯ç¤ºç³»çµ±ç‹€æ…‹ã€WiFi é€£æ¥å’Œçµ±è¨ˆä¿¡æ¯
- âœ… **æŒ‰éˆ•æ§åˆ¶**ï¼šéŸ³é‡æ§åˆ¶å’Œéº¥å…‹é¢¨é–‹é—œ
- âœ… **å¤šä»»å‹™è™•ç†**ï¼šåŸºæ–¼ FreeRTOS çš„ä¸¦è¡Œè™•ç†æ¶æ§‹

## ğŸ”Œ ç¡¬é«”é…ç½®èˆ‡æ¥ç·š

### ESP32-S3 N16R8 é–‹ç™¼æ¿

æ¨è–¦è³¼è²·ï¼š[ESP32-S3 N16R8 é–‹ç™¼æ¿](https://www.taiwansensor.com.tw/product/esp32-s3-devkitc-1-%E9%96%8B%E7%99%BC%E6%9D%BF-%E6%A8%82%E9%91%AB-wroom-1-n16r8-%E5%B7%B2%E7%84%8A%E6%8E%A5%E9%87%9D%E8%85%B3/?srsltid=AfmBOopRlAkA0Pqg56TTQj8SVzKgSCUIz-w4B6i-VNpxVR8ESW0LrRBx)

### I2S éº¥å…‹é¢¨æ¥ç·š (INMP441 æ¨è–¦)

| åŠŸèƒ½ | ESP32-S3 å¼•è…³ | I2S éº¥å…‹é¢¨ | èªªæ˜ |
|------|---------------|------------|------|
| æ™‚é˜ä¿¡è™Ÿ | GPIO20 | SCK (BCLK) | I2S ä½æ™‚é˜ |
| å­—é¸æ“‡ | GPIO18 | WS (LR) | å·¦å³è²é“é¸æ“‡ |
| æ•¸æ“šè¼¸å…¥ | GPIO21 | SD (DATA) | éŸ³è¨Šæ•¸æ“š |
| é›»æº | 3.3V | VDD (VCC) | é›»æºæ­£æ¥µ |
| æ¥åœ° | GND | GND | é›»æºè² æ¥µ |
| è²é“é¸æ“‡ | GND | L/R | å·¦è²é“é¸æ“‡ |

```
     INMP441                    ESP32-S3
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ VDD     â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ 3.3V    â”‚
   â”‚ GND     â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ GND     â”‚  
   â”‚ L/R     â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ GND     â”‚
   â”‚ WS      â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ GPIO18  â”‚
   â”‚ SCK     â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ GPIO20  â”‚
   â”‚ SD      â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ GPIO21  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OLED é¡¯ç¤ºæ¨¡çµ„ (SH1106/SSD1306)

| åŠŸèƒ½ | ESP32-S3 å¼•è…³ | OLED æ¨¡çµ„ |
|------|---------------|-----------|
| é›»æº | 3.3V | VCC |
| æ¥åœ° | GND | GND |
| I2C æ™‚é˜ | GPIO9 | SCL |
| I2C æ•¸æ“š | GPIO8 | SDA |

### LED æ§åˆ¶ç³»çµ±

#### RGB LED (å…±é™°æ¥µ)

| é¡è‰² | ESP32-S3 å¼•è…³ |
|------|---------------|
| ç´…è‰² | GPIO35 |
| ç¶ è‰² | GPIO36 |
| è—è‰² | GPIO37 |

#### NeoPixel/WS2812B LED

| åŠŸèƒ½ | ESP32-S3 å¼•è…³ |
|------|---------------|
| æ•¸æ“šè¼¸å…¥ | GPIO48 |
| é›»æº | 5V |
| æ¥åœ° | GND |

### æŒ‰éˆ•æ§åˆ¶

| åŠŸèƒ½ | ESP32-S3 å¼•è…³ | æ¥ç·šæ–¹å¼ |
|------|---------------|----------|
| éŸ³é‡å¢åŠ  | GPIO1 | æŒ‰éˆ• -> GND |
| éŸ³é‡æ¸›å°‘ | GPIO2 | æŒ‰éˆ• -> GND |
| éº¥å…‹é¢¨æ§åˆ¶ | GPIO42 | æŒ‰éˆ• -> GND |

## âš™ï¸ è»Ÿé«”å®‰è£èˆ‡é…ç½®

### 1. é–‹ç™¼ç’°å¢ƒè¨­ç½®

```bash
# å®‰è£ PlatformIO
pip install platformio

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd "d:\workspace\study\ProjectG"

# ç·¨è­¯å°ˆæ¡ˆ
pio run

# ä¸Šå‚³ç¨‹å¼
pio run --target upload

# ç›£æ§ä¸²åˆ—è¼¸å‡º
pio device monitor
```

### 2. WiFi è¨­ç½®

åœ¨ `src/main.cpp` ä¸­ä¿®æ”¹ WiFi è¨­å®šï¼š

```cpp
// WiFi è¨­ç½®
const char *ssid = "æ‚¨çš„WiFiåç¨±";
const char *password = "æ‚¨çš„WiFiå¯†ç¢¼";
```

### 3. MQTT æœå‹™å™¨è¨­ç½®

ç³»çµ±å·²é è¨­ä½¿ç”¨å…è²»çš„ Eclipse Mosquitto å…¬å…±æœå‹™å™¨ï¼š

```cpp
// MQTT è¨­ç½®
const char *mqttServer = "test.mosquitto.org";
const int mqttPort = 1883;
const char *mqttUser = nullptr;     // ç„¡éœ€èªè­‰
const char *mqttPassword = nullptr; // ç„¡éœ€èªè­‰
```

## ğŸ“¡ MQTT å”è­°æ¶æ§‹

### MQTT ä¸»é¡Œçµæ§‹

| ä¸»é¡Œ | æ–¹å‘ | å…§å®¹ | æ ¼å¼ |
|------|------|------|------|
| `esp32/audio/raw` | ç™¼å¸ƒ | åŸå§‹éŸ³è¨Šæ•¸æ“š | JSON |
| `esp32/audio/mfcc` | ç™¼å¸ƒ | MFCC ä¿‚æ•¸ (13å€‹) | JSON |
| `esp32/audio/mel` | ç™¼å¸ƒ | æ¢…çˆ¾èƒ½é‡ (26å€‹) | JSON |
| `esp32/audio/features` | ç™¼å¸ƒ | éŸ³è¨Šç‰¹å¾µ | JSON |
| `esp32/audio/status` | ç™¼å¸ƒ | ç³»çµ±ç‹€æ…‹ | JSON |
| `esp32/audio/control` | è¨‚é–± | æ§åˆ¶å‘½ä»¤ | JSON |

### æ§åˆ¶å‘½ä»¤

ç™¼é€åˆ° `esp32/audio/control` ä¸»é¡Œï¼š

```json
// é–‹å§‹éŸ³è¨Šç™¼å¸ƒ
{"command": "startPublishing", "timestamp": 1234567890}

// åœæ­¢éŸ³è¨Šç™¼å¸ƒ
{"command": "stopPublishing", "timestamp": 1234567890}

// å•Ÿç”¨ç‰¹å¾µæå–
{"command": "enableFeatures", "timestamp": 1234567890}

// åœç”¨ç‰¹å¾µæå–
{"command": "disableFeatures", "timestamp": 1234567890}
```

## ğŸ”¬ éŸ³è¨Šç‰¹å¾µæå–

### ç‰¹å¾µé¡å‹

1. **MFCC ä¿‚æ•¸ (13å€‹)**ï¼šèªéŸ³è­˜åˆ¥å¸¸ç”¨ç‰¹å¾µ
2. **æ¢…çˆ¾æ¿¾æ³¢å™¨çµ„èƒ½é‡ (26å€‹)**ï¼šæ¢…çˆ¾åˆ»åº¦çš„é »è­œèƒ½é‡
3. **é »è­œé‡å¿ƒ**ï¼šé »è­œçš„"é‡å¿ƒ"ä½ç½®
4. **é »è­œå¸¶å¯¬**ï¼šé »è­œèƒ½é‡çš„åˆ†æ•£ç¨‹åº¦
5. **éé›¶ç‡**ï¼šéŸ³è¨Šä¿¡è™Ÿçš„éé›¶é »ç‡
6. **RMS èƒ½é‡**ï¼šéŸ³è¨Šä¿¡è™Ÿçš„å‡æ–¹æ ¹èƒ½é‡

### è™•ç†åƒæ•¸

- **æ¡æ¨£ç‡**ï¼š16 kHz
- **ä½æ·±åº¦**ï¼š16 ä½
- **FFT å¤§å°**ï¼š512
- **è¦–çª—å¤§å°**ï¼š400 æ¨£æœ¬ (25ms)
- **è·³èºå¤§å°**ï¼š160 æ¨£æœ¬ (10ms)

## ğŸš€ å…è²» MQTT æœå‹™å™¨

### æ¨è–¦æœå‹™å™¨

#### 1. Eclipse Mosquitto (é è¨­ï¼Œæ¨è–¦)

```cpp
const char *mqttServer = "test.mosquitto.org";
const int mqttPort = 1883;
```

- âœ… æœ€ç©©å®šï¼šEclipse åŸºé‡‘æœƒå®˜æ–¹ç¶­è­·
- âœ… ç„¡éœ€è¨»å†Šï¼šç›´æ¥ä½¿ç”¨
- âœ… å…¨çƒå¯ç”¨ï¼š24/7 å¯ç”¨æ€§

#### 2. HiveMQ å…¬å…±æœå‹™å™¨

```cpp
const char *mqttServer = "broker.hivemq.com";
const int mqttPort = 1883;
```

#### 3. EMQX å…¬å…±æœå‹™å™¨

```cpp
const char *mqttServer = "broker.emqx.io";
const int mqttPort = 1883;
```

## ğŸ§ª æ¸¬è©¦èˆ‡é©—è­‰

### Python æ¸¬è©¦è…³æœ¬

```bash
# ç°¡å–® MQTT æ¸¬è©¦
python simple_mqtt_test.py

# éŸ³è¨Šå®¢æˆ¶ç«¯æ¸¬è©¦
python test_mqtt_audio_client.py

# æœå‹™å™¨é€£æ¥æ¸¬è©¦
python test_mqtt_servers.py
```

### MQTT å®¢æˆ¶ç«¯å·¥å…·æ¸¬è©¦

```bash
# è¨‚é–±æ‰€æœ‰éŸ³è¨Šä¸»é¡Œ
mosquitto_sub -h test.mosquitto.org -t "esp32/audio/#" -v

# ç™¼é€æ§åˆ¶å‘½ä»¤
mosquitto_pub -h test.mosquitto.org -t "esp32/audio/control" -m '{"command":"startPublishing"}'
```

## ğŸ“ å°ˆæ¡ˆæª”æ¡ˆçµæ§‹

```text
ProjectG/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.cpp                 # ä¸»ç¨‹å¼
â”‚   â”œâ”€â”€ AudioMqttManager.cpp     # MQTT éŸ³è¨Šç®¡ç†
â”‚   â”œâ”€â”€ AudioFeatureExtractor.cpp # éŸ³è¨Šç‰¹å¾µæå–
â”‚   â”œâ”€â”€ LedController.cpp        # LED æ§åˆ¶
â”‚   â”œâ”€â”€ OledDisplay.cpp          # OLED é¡¯ç¤º
â”‚   â””â”€â”€ AudioPlayer.cpp          # éŸ³è¨Šæ’­æ”¾
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ AudioMqttManager.h
â”‚   â”œâ”€â”€ AudioFeatureExtractor.h
â”‚   â”œâ”€â”€ LedController.h
â”‚   â”œâ”€â”€ OledDisplay.h
â”‚   â””â”€â”€ AudioPlayer.h
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ simple_mqtt_test.py      # ç°¡å–® MQTT æ¸¬è©¦
â”‚   â”œâ”€â”€ test_mqtt_audio_client.py # éŸ³è¨Šå®¢æˆ¶ç«¯æ¸¬è©¦
â”‚   â””â”€â”€ test_mqtt_servers.py     # æœå‹™å™¨æ¸¬è©¦
â”œâ”€â”€ platformio.ini               # PlatformIO é…ç½®
â””â”€â”€ README.md                    # æœ¬èªªæ˜æ–‡ä»¶
```

## ğŸ“ ä¾è³´å¥—ä»¶

å·²åœ¨ `platformio.ini` ä¸­é…ç½®ï¼š

```ini
lib_deps = 
    adafruit/Adafruit NeoPixel@^1.11.0
    thingpulse/ESP8266 and ESP32 OLED driver for SSD1306 displays@^4.4.0
    bblanchon/ArduinoJson@^7.0.0
    knolleary/PubSubClient@^2.8
```

## â“ å¸¸è¦‹å•é¡Œ

### Q1: ç·¨è­¯éŒ¯èª¤ "No such file or directory"

**A**: ç¢ºä¿å·²å®‰è£æ‰€æœ‰ä¾è³´å¥—ä»¶ï¼š`pio lib install`

### Q2: WiFi é€£æ¥å¤±æ•—

**A**: æª¢æŸ¥ WiFi æ†‘è­‰å’Œä¿¡è™Ÿå¼·åº¦ï¼Œç¢ºä¿ä½¿ç”¨ 2.4GHz ç¶²è·¯ã€‚

### Q3: MQTT é€£æ¥å¤±æ•—

**A**: æª¢æŸ¥ç¶²è·¯é€£æ¥ï¼Œå˜—è©¦å…¶ä»– MQTT æœå‹™å™¨ï¼Œæª¢æŸ¥é˜²ç«ç‰†è¨­å®šã€‚

### Q4: éº¥å…‹é¢¨ç„¡è²éŸ³

**A**: æª¢æŸ¥æ¥ç·šæ˜¯å¦æ­£ç¢ºï¼Œç¢ºèªéº¥å…‹é¢¨é›»æºä¾›æ‡‰ï¼Œæª¢æŸ¥ GPIO å¼•è…³é…ç½®ã€‚

### Q5: OLED ä¸é¡¯ç¤º

**A**: æª¢æŸ¥ I2C æ¥ç·šï¼Œç¢ºèª OLED æ¨¡çµ„é¡å‹ï¼Œæª¢æŸ¥é›»æºä¾›æ‡‰ã€‚

---

**å°ˆæ¡ˆç‰ˆæœ¬**: 2.0 MQTT  
**æœ€å¾Œæ›´æ–°**: 2024å¹´12æœˆ  
**ç›¸å®¹æ€§**: ESP32-S3, PlatformIO, Arduino Framework  
**æˆæ¬Š**: MIT License
